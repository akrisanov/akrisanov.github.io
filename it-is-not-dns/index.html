
<!DOCTYPE html>
<html lang="en">
<head>
<script src="https://akrisanov.com/js/theme.min.js" integrity="sha384-pb++s6uBRKaQv+iAXpgA/H3IlpLZdO14tTwuCI7uXmz4aaZdByoCcM+6BhynMq/1"></script>
<link rel="stylesheet"
  href="https://akrisanov.com/abridge.css?h=7cb460406165e24193ad" />
<meta charset="utf-8" />
<meta http-equiv="x-ua-compatible" content="ie=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="base" content="https://akrisanov.com" />

<meta name="content-language" content="en" />
<meta name="HandheldFriendly" content="True" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="theme-color" content="#333333" />
<meta name="msapplication-TileColor" content="#333333" />
<link rel="manifest" href="https://akrisanov.com/manifest.min.json" />
<link rel="mask-icon" href="https://akrisanov.com/safari-pinned-tab.svg"
  color="#ff9900" />
<link rel="icon" type="image/svg+xml"
  href="https://akrisanov.com/favicon.png" />
<link rel="apple-touch-icon" sizes="180x180"
  href="https://akrisanov.com/apple-touch-icon.png" />
<link rel="preload" as="style" class="preStyle" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous" />
<link rel="alternate" type="application/atom+xml" title="Andrey Krisanov Atom Feed"
  href="https://akrisanov.com/atom.xml" />
<link rel="alternate" type="application/rss+xml" title="Andrey Krisanov RSS Feed"
  href="https://akrisanov.com/rss.xml" /> <meta name="robots" content="index, follow" />
<meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
<meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
<title>My "It's not DNS" story | Andrey Krisanov</title>
<meta name="author" content="Andrey Krisanov" />
<meta name="copyright" content="Andrey Krisanov" />
<meta name="description" content="The story about the DNS resolver, Linux VMs, experienced infrastructure team, and me troubleshooting an incident happened on Sunday morning." />
<link rel="canonical" href="https://akrisanov.com/it-is-not-dns/" />
<link rel="alternate" hreflang="en" href="https://akrisanov.com/it-is-not-dns/" />
<link rel="alternate" hreflang="x-default" href="https://akrisanov.com/it-is-not-dns/" />
<meta name="keywords" content="dns, linux, troubleshooting, AI infrastructure, inference engineering, LLM serving, distributed systems, scalable backend, performance optimization, reliability, observability, MLOps, DevOps, GPU inference, model serving, vLLM, Triton Inference Server, Ray Serve, .NET, C#, Python, Kubernetes, Docker, Terraform, Ansible, OpenTelemetry, Grafana, CI&#x2F;CD, cloud infrastructure, platform engineering" />
<meta name="google-site-verification" content="Your Google Site verification code." />
<meta name="msvalidate.01" content="Your Bing Site verification code." />
<meta property="og:url" content="https://akrisanov.com/it-is-not-dns/" />
<meta name="twitter:url" content="https://akrisanov.com/it-is-not-dns/" />
<meta property="og:description" content="The story about the DNS resolver, Linux VMs, experienced infrastructure team, and me troubleshooting an incident happened on Sunday morning." />
<meta name="twitter:description" content="The story about the DNS resolver, Linux VMs, experienced infrastructure team, and me troubleshooting an incident happened on Sunday morning." />
<meta property="og:title" content="My &quot;It&#x27;s not DNS&quot; story | Andrey Krisanov" />
<meta name="twitter:title" content="My &quot;It&#x27;s not DNS&quot; story | Andrey Krisanov" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://akrisanov.com/images/karusel-arch.jpg" />
<meta property="og:image" content="https://akrisanov.com/images/karusel-arch.jpg" />
<meta property="og:site_name" content="Andrey Krisanov" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="website" />
<meta property="og:updated_time" content="2023-08-12" />
<meta name="twitter:site" content="@_akrisanov" />
<meta name="twitter:creator" content="@_akrisanov" /><script type="application/ld+json">
{
	"@context": "https://schema.org",
	"@type": "Article",
	"headline": "My \"It's not DNS\" story",
	"url": "https://akrisanov.com/it-is-not-dns/",
	"inLanguage": "en",
	"author": {
		"@type": "Person",
		"name": "Andrey Krisanov"
	},
	"image": "https://akrisanov.com/images/karusel-arch.jpg",
	"datePublished": "2023-08-12T00:00:00+00:00",
	"dateModified": "2023-08-12T00:00:00+00:00"}
</script>
<script defer
  src="https://akrisanov.com/js/abridge.min.js?h=1a12cf684ae4ed40434f" integrity="sha384-ZsreuwU2rKTp7gC4bTf5sYz+3AjMym99XDa/B5wa08fCzLVVX+NDaTsTeyLXseDG"></script>
<noscript>
  <link rel="stylesheet" href="https://akrisanov.com/nojs.css" />
</noscript>
  
  <script>
    (function(){
      try {
        var pref = "";
        if (pref) {
          document.documentElement.classList.add('js');
          document.addEventListener('DOMContentLoaded', function(){
            document.body.classList.add(pref);
          });
        }
      } catch(e){}
    })();
  </script>
</head>
<body>
  <a class="visually-hidden" href="#main-content">Skip to content</a>
  <header>
    <nav>
      <div><h1><a href="https://akrisanov.com" title="Andrey Krisanov"><big>Andrey Krisanov</big></a></h1></div>
      <div>

        <div>
          <ul><li><a class="s95" href="https://akrisanov.com/about/"
                  > About 
                </a></li><li><a class="s95" href="https://akrisanov.com/archive/"
                  >
                <i class="fa fa-bookmark" aria-hidden="true" title="Posts"></i>
                
                </a></li>
            <li><div class="dropdown"><i class="svgs world" type="reset" role="button" tabindex="0" aria-label="English"></i>
                <div class="dropdown-content">
                <span>English</span><a href="https://akrisanov.com/ru/it-is-not-dns/">Русский</a></div>
            </div></li><li>
          <i type="reset" id="mode" class="js svgs adjust" role="button" tabindex="0"
            title="Switch Mode"
            aria-label="Switch Mode"></i></ul>
        </div>

        <div>
          <div>
            <form autocomplete=off class="js" name="goSearch" id="searchbox" role="search" aria-label="Search">
              <div class="searchd">
      <input id="searchinput" type="text" placeholder="Search"
        aria-label="Search" title="Search" />
                <button type="submit" title="Search" aria-label="Search" class="svgs search"></button>
              </div>
              <div class="results" aria-live="polite"><div id="suggestions"></div></div>
            </form>
          </div>
        </div>

      </div>
    </nav>
  </header>
  <main id="main-content">
<article>
<h1><a href="https://akrisanov.com/it-is-not-dns/">My "It's not DNS" story</a></h1>

<span class="s95" > August 12, 2023<span class="hpad">·</span> #<a
    href="https://akrisanov.com/tags/dns/">dns</a>  #<a
    href="https://akrisanov.com/tags/linux/">linux</a> </span>  <p>Summer of 2019. I'm joining a large retail organization that is undergoing a digital transformation.
The role I've been hired for is a technical leadership role. The project I'm taking over doesn't
even have a complete team yet, which means I'll be wearing all sorts of hats until I hire someone
and delegate work. You could say, I'm the only "developer" on the team. Also, the code base is
already serving users, and the services are part of a lead generation funnel for one of the grocery
networks. So if something goes down, the company loses potential customers and revenue. The fact
that the project was developed by an outsourced team that has already left without handing over
proper documentation makes things more complicated and fragile.</p>
<p>In a few days, I try to understand how the services are run in production, write missing README
and system design papers, and create initial tasks for maintenance. All goes well, and I manage
to deploy some changes to the backend. It's Friday afternoon, so I still have time to do
a rollback if I've made a mistake. But nothing suspicious has been observed during the day,
and I leave the office for the weekend.</p>
<p>The fun begins on Sunday. Because I'm in charge of the project, I'm the one who is on-call.
I get a call from our support team telling me that the web application isn't responding from time
to time and that they're getting complaints from customers.</p>
<p>The first thing I do is open my browser to check what users are seeing. Surprisingly, a web page
loads just fine. I hit refresh – same result. Then I turn off Wi-Fi on my iPhone and open
Safari – 504 error. It's a Nginx page. Now it is something.</p>
<p><img src="/images/karusel-arch.jpg" alt="Simplified diagram of the project architecture" />
<span class="img-title">Simplified diagram of the project architecture</span></p>
<p>I open the monitoring and observe no high load. CPU usage is low, more than 50% of memory is free,
plenty of free disk space on each of the virtual machines, no spikes in the network bandwidth.
Looking at the Nginx logs only proves that there's a gateway timeout error related to the backend.
I should check the application backend logs. Nothing there, no errors at all.</p>
<p>At this point, I start to blame the network and call the network infrastructure team.
These guys work on an organisational level and potentially can see what I can't. After spending
an hour investigating together, we see nothing. It's already Sunday evening, and
I'm almost hopeless.</p>
<p>I decide to take a break and go for a walk. When I'm back, I try to ssh to a VM again. Suddenly,
I notice a few seconds of delay before I can type my commands into a terminal. "It can't be DNS",
I say to myself. To prove it, I ping a public domain from our network. Again, a few seconds of
delay and the network packets are flying without a hitch.
"If DNS was down, the infrastructure team would notice.", I continue to reason.
Before escalating the situation further to upper management, I choose to check the DNS
configuration on the backend virtual machines.</p>
<p>The /etc/resolv.conf is a DNS resolver configuration file. It contains records in the following format:</p>
<pre data-lang="bash" style="background-color:#3b224c;color:#dbbfef;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#a4a0e8;">nameserver </span><span style="color:#eccdbb;">[</span><span>ip</span><span style="color:#eccdbb;">]
</span><span style="color:#a4a0e8;">nameserver </span><span style="color:#eccdbb;">[</span><span>ip</span><span style="color:#eccdbb;">]
</span></code></pre>
<p>In my developer's mind, a Linux machine receives these records at boot time and caches them.
This file is then queried to resolve domains. What could possibly go wrong? Well, I ask the
infrastructure team about the IP addresses I see in <code>/etc/resolv.conf</code> and get a surprising
answer: "The IP addresses are DNS load balancers and the first one in the list is currently down".
Hearing this, I begin to understand why the ssh and initial ping delays are happening.
The first DNS load balancer is queried, but because it's down, it doesn't respond, and
the resolution continues with the second IP address.</p>
<p>I remove the first nameserver from <code>/etc/resolv.conf</code> and drop the DNS cache on each of the VMs.
After a few seconds, the 504 error and the gateway timeout disappear. In the morning, we'll
discuss the incident with the infrastructure team and senior management. Fun week ahead.</p>
<div class="callout callout-bdc">
<p>
    It's not DNS<br/>
    There's no way it's DNS<br/>
    It was DNS
</p>
<p class="author">Old Japanese Haiku</p>
</div>

    <nav>
      <div>
        <a href="https://akrisanov.com/choosing-kafka/">&#8249; Choosing Apache Kafka For A New Project – A Questionnaire</a>
      </div>
      <div>
        <a href="https://akrisanov.com/multi-arch-docker-images/"> Building Multi-Arch Images for Arm and x86 &#8250;</a>
      </div>
    </nav>
</article>
  </main>
  <footer>
    <hr />
    <div class="c">
<nav class="tpad">
    <div></div>
</nav>
          
      <p class="s90"> © <span id="year">2025</span> Andrey Krisanov</p>
      <nav>
          <a class="s90"
            href="https://akrisanov.com/atom.xml"
             target="_blank" rel="noopener noreferrer"
            aria-label=" RSS "
          ><i class="fa fa-rss" aria-hidden="true" title=" RSS "></i></a>
          <a class="s90"
            href="https://akrisanov.com/sitemap.xml"
             target="_blank" rel="noopener noreferrer"
            aria-label=" Sitemap "
          ><i class="fa fa-sitemap" aria-hidden="true" title=" Sitemap "></i></a>
          <a class="s90"
            href="https://akrisanov.com/links"
             target="_blank" rel="noopener noreferrer"
            aria-label=" Contacts "
          ><i class="fa fa-address-card" aria-hidden="true" title=" Contacts "></i></a>
          <a class="s90"
            href="https://www.linkedin.com/in/akrisanov/"
             target="_blank" rel="noopener noreferrer"
            aria-label=" LinkedIn "
          ><i class="fa fa-linkedin" aria-hidden="true" title=" LinkedIn "></i></a>
          <a class="s90"
            href="https://github.com/akrisanov/"
             target="_blank" rel="noopener noreferrer"
            aria-label=" Github "
          ><i class="fa fa-github" aria-hidden="true" title=" Github "></i></a>
      </nav>
    </div>
  </footer><span class="topout">
  <span class="topleft"> </span
  ><a href="#" class="top" title="Back to Top"
    ><i class="svgs svgh angu"></i></a
  >
</span>
</body>
</html>

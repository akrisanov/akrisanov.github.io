
<!DOCTYPE html>
<html lang="ru">
<head>
<script src="https://akrisanov.com/js/theme.min.js" integrity="sha384-pb++s6uBRKaQv+iAXpgA/H3IlpLZdO14tTwuCI7uXmz4aaZdByoCcM+6BhynMq/1"></script>
<link rel="stylesheet"
  href="https://akrisanov.com/abridge.css?h=7cb460406165e24193ad" />
<meta charset="utf-8" />
<meta http-equiv="x-ua-compatible" content="ie=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="base" content="https://akrisanov.com" />

<meta name="content-language" content="ru" />
<meta name="HandheldFriendly" content="True" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="theme-color" content="#333333" />
<meta name="msapplication-TileColor" content="#333333" />
<link rel="manifest" href="https://akrisanov.com/ru/manifest.min.json" />
<link rel="mask-icon" href="https://akrisanov.com/safari-pinned-tab.svg"
  color="#ff9900" />
<link rel="icon" type="image/svg+xml"
  href="https://akrisanov.com/favicon.png" />
<link rel="apple-touch-icon" sizes="180x180"
  href="https://akrisanov.com/apple-touch-icon.png" />
<link rel="preload" as="style" class="preStyle" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous" />
<link rel="alternate" type="application/atom+xml" title="Андрей Крисанов Atom Feed"
  href="https://akrisanov.com/ru/atom.xml" /> <meta name="robots" content="index, follow" />
<meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
<meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
<title>Сборка образов на Gitlab CI для GCP Artifact Registry | Андрей Крисанов</title>
<meta name="author" content="Andrey Krisanov" />
<meta name="copyright" content="Андрей Крисанов" />
<meta name="description" content="Как собрать Docker-образы в Gitlab CI и отправить их в Google Artifact Registry." />
<link rel="canonical" href="https://akrisanov.com/ru/gitlab-kaniko-artifact-registry/" />
<link rel="alternate" hreflang="ru" href="https://akrisanov.com/ru/gitlab-kaniko-artifact-registry/" />

<meta name="keywords" content="docker, gitlab, CI, Google Cloud, GCP, Artifact Registry, AI infrastructure, inference engineering, LLM serving, distributed systems, scalable backend, performance optimization, reliability, observability, MLOps, DevOps, GPU inference, model serving, vLLM, Triton Inference Server, Ray Serve, .NET, C#, Python, Kubernetes, Docker, Terraform, Ansible, OpenTelemetry, Grafana, CI&#x2F;CD, cloud infrastructure, platform engineering" />
<meta name="google-site-verification" content="Your Google Site verification code." />
<meta name="msvalidate.01" content="Your Bing Site verification code." />
<meta property="og:url" content="https://akrisanov.com/ru/gitlab-kaniko-artifact-registry/" />
<meta name="twitter:url" content="https://akrisanov.com/ru/gitlab-kaniko-artifact-registry/" />
<meta property="og:description" content="Как собрать Docker-образы в Gitlab CI и отправить их в Google Artifact Registry." />
<meta name="twitter:description" content="Как собрать Docker-образы в Gitlab CI и отправить их в Google Artifact Registry." />
<meta property="og:title" content="Сборка образов на Gitlab CI для GCP Artifact Registry | Андрей Крисанов" />
<meta name="twitter:title" content="Сборка образов на Gitlab CI для GCP Artifact Registry | Андрей Крисанов" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://akrisanov.com/images/kaniko-build-pipeline.png" />
<meta property="og:image" content="https://akrisanov.com/images/kaniko-build-pipeline.png" />
<meta property="og:site_name" content="Андрей Крисанов" />
<meta property="og:locale" content="ru_RU" />
<meta property="og:type" content="website" />
<meta property="og:updated_time" content="2022-07-12" />
<meta name="twitter:site" content="@_akrisanov" />
<meta name="twitter:creator" content="@_akrisanov" /><script type="application/ld+json">
{
	"@context": "https://schema.org",
	"@type": "Article",
	"headline": "Сборка образов на Gitlab CI для GCP Artifact Registry",
	"url": "https://akrisanov.com/ru/gitlab-kaniko-artifact-registry/",
	"inLanguage": "ru",
	"author": {
		"@type": "Person",
		"name": "Andrey Krisanov"
	},
	"image": "https://akrisanov.com/images/kaniko-build-pipeline.png",
	"datePublished": "2022-07-12T00:00:00+00:00",
	"dateModified": "2022-07-12T00:00:00+00:00"}
</script>
<script defer
  src="https://akrisanov.com/js/abridge.min.js?h=1a12cf684ae4ed40434f" integrity="sha384-ZsreuwU2rKTp7gC4bTf5sYz+3AjMym99XDa/B5wa08fCzLVVX+NDaTsTeyLXseDG"></script>
<script defer src="https://akrisanov.com/js/lunr.stemmer.support.min.js"
  integrity="sha384-f0MKdC/9ZSGTpDiuWusC0SbLXNCBp6NgzDZpjR/4UdHXAQBqvTEKyinnsa1wQ7oA"></script>
<script defer src="https://akrisanov.com/js/lunr.ru.min.js"
  integrity="sha384-R9oqgx8XLmQUPG/odEJyFPd90/TbRU0/6q+If/f8d5yDqLhZgtOT5/X9r3O1Etjr"></script>
<noscript>
  <link rel="stylesheet" href="https://akrisanov.com/nojs.css" />
</noscript>
  
  <script>
    (function(){
      try {
        var pref = "";
        if (pref) {
          document.documentElement.classList.add('js');
          document.addEventListener('DOMContentLoaded', function(){
            document.body.classList.add(pref);
          });
        }
      } catch(e){}
    })();
  </script>
</head>
<body>
  <a class="visually-hidden" href="#main-content">Skip to content</a>
  <header>
    <nav>
      <div><h1><a href="https://akrisanov.com/ru/" title="Андрей Крисанов"><big>Андрей Крисанов</big></a></h1></div>
      <div>

        <div>
          <ul><li><a class="s95" href="https://akrisanov.com/ru/about/"
                  > Обо мне 
                </a></li><li><a class="s95" href="https://akrisanov.com/ru/archive/"
                  >
                <i class="fa fa-bookmark" aria-hidden="true" title="Посты"></i>
                
                </a></li>
            <li><div class="dropdown"><i class="svgs world" type="reset" role="button" tabindex="0" aria-label="Русский"></i>
                <div class="dropdown-content">
                <span>Русский</span><a href="https://akrisanov.com/gitlab-kaniko-artifact-registry/">English</a></div>
            </div></li><li>
          <i type="reset" id="mode" class="js svgs adjust" role="button" tabindex="0"
            title="Switch Mode"
            aria-label="Switch Mode"></i></ul>
        </div>

        <div>
          <div>
            <form autocomplete=off class="js" name="goSearch" id="searchbox" role="search" aria-label="Поиск">
              <div class="searchd">
      <input id="searchinput" type="text" placeholder="Поиск"
        aria-label="Поиск" title="Поиск" />
                <button type="submit" title="Поиск" aria-label="Поиск" class="svgs search"></button>
              </div>
              <div class="results" aria-live="polite"><div id="suggestions"></div></div>
            </form>
          </div>
        </div>

      </div>
    </nav>
  </header>
  <main id="main-content">
<article>
<h1><a href="https://akrisanov.com/ru/gitlab-kaniko-artifact-registry/">Сборка образов на Gitlab CI для GCP Artifact Registry</a></h1>

<span class="s95" > июля 12, 2022<span class="hpad">·</span> #<a
    href="https://akrisanov.com/ru/tags/devops/">devops</a>  #<a
    href="https://akrisanov.com/ru/tags/docker/">docker</a>  #<a
    href="https://akrisanov.com/ru/tags/gitlab/">gitlab</a>  #<a
    href="https://akrisanov.com/ru/tags/google-cloud/">Google Cloud</a> </span>  <p>Пару дней назад потребовалось автоматизировать сборку образов для контейнеров веб-платформы, которая
разворачивается в Google Kubernetes Engine (GKE). До этого момента сборка выполнялась локально на
машинах разработчиков при помощи Docker и собранные образы отправлялись в Google Artifact Registry.
Кроме того, стали появляться дополнительные тестовые и демо-окружения, требующие небольших изменений,
например, в конфигурации фронтенда. Перечисленное также усложняло жизнь solution и sales-инженерам,
разворачивающих систему у клиентов.</p>
<p>Чтобы сэкономить время и другие ресурсы, решено было добавить дополнительный этап в существующий
пайплайн с банальным именем <code>build</code> и выполнять рутиные операции после успешного прохождения
линтеров и тестов.</p>
<p>Первое с чем я столкнулся, это непонимание как запущен и сконфигурирован Gitlab Runner.
Так как наш DevOps-инженер в это удачное время оказался в отпуске, пришлось самому проверять настройки CI.
От того, какой тип раннера используется для выполнения пайплайнов, зависят в том числе и возможности сборки.
В моем случае используется Kubernetes Runner и задачи прогоняются в контейнерах.
Следовательно, чтобы собрать образы в таком окружении, потребуется <a rel="noopener" target="_blank" href="https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker">Docker внутри контейнера</a>.
И с этим сразу начинаются проблемы, которые связаны с привелегированным доступом к сокету Docker,
стабильностью пайплайна в целом, безопасностью и <a rel="noopener" target="_blank" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md#deprecation">желанием Kubernets уйти от Docker-образов</a>
в будущем. Проведя несколько экспериментов, решил отказаться от изначального плана.</p>
<p>Обойтись без dind (Docker-in-Docker) помогает Kaniko. <a rel="noopener" target="_blank" href="https://docs.gitlab.com/ee/ci/docker/using_kaniko.html">Официальная страница документации Gitlab</a>
неплохо описывает весь процесс сборки. Единственная сложность, которая у меня возникла, была связана
с аутентификацией GCP Artifact Registry.</p>
<p>Для аутентификации раннера нужно создать <a rel="noopener" target="_blank" href="https://console.cloud.google.com/iam-admin/serviceaccounts">сервисный аккаунт</a>
в разделе IAM &amp; Admin.</p>
<p><img src="/images/gcp-service-account.png" alt="Создание сервисного аккаунта" />
<span class="img-title">Создание сервисного аккаунта</span></p>
<p>Далее сгенерировать приватный ключ в формате JSON и скачать его.</p>
<p><img src="/images/gcp-private-key.png" alt="Генерация нового приватного ключа" />
<span class="img-title">Генерация нового приватного ключа</span></p>
<p>Выдать права доступа к Artifact Registry для сервисного аккаунта.</p>
<p><img src="/images/gcp-roles.png" alt="Назначение ролей Artifact Registry Reader и Artifact Registry Writer" />
<span class="img-title">Назначение ролей Artifact Registry Reader и Artifact Registry Writer</span></p>
<p>Роль <code>Artifact Registry Reader</code> необходима для скачивания образов и кеширования,
роль <code>Artifact Registry Writer</code> – для публикации образов. В интернете можно найти руководства,
которые предлагают указывать роль <code>Storage Admin</code>, но, на мой взгляд, это плохая практика.</p>
<p>С настройкой на стороне облака закончено, остается раннер и Kaniko, который для аутентификации GCP
читает специальную переменную <code>GOOGLE_APPLICATION_CREDENTIALS</code>. Чтобы записать в нее содержимое
приватного ключа в формате JSON, потребуется перевести его в base64.</p>
<p>В настройках CI/CD репозитория следует добавить переменную окружения и скопировать в качестве
значения base64 строку.</p>
<p><img src="/images/gitlab-env.png" alt="Создание переменной GOOGLE_APPLICATION_CREDENTIALS" />
<span class="img-title">Создание переменной <code>GOOGLE_APPLICATION_CREDENTIALS</code></span></p>
<pre data-lang="yml" style="background-color:#3b224c;color:#dbbfef;" class="language-yml "><code class="language-yml" data-lang="yml"><span style="color:#ffffff;">backend:build</span><span>:
</span><span>  </span><span style="color:#ffffff;">stage</span><span>: </span><span style="color:#cccccc;">build
</span><span>  </span><span style="color:#ffffff;">image</span><span>:
</span><span>    </span><span style="color:#ffffff;">name</span><span>: </span><span style="color:#cccccc;">gcr.io/kaniko-project/executor:debug
</span><span>    </span><span style="color:#ffffff;">entrypoint</span><span>: [</span><span style="color:#cccccc;">&quot;&quot;</span><span>]
</span><span>  </span><span style="color:#ffffff;">variables</span><span>:
</span><span>    </span><span style="color:#ffffff;">GOOGLE_APPLICATION_CREDENTIALS</span><span>: </span><span style="color:#cccccc;">/kaniko/kaniko-secret.json
</span><span>    </span><span style="color:#ffffff;">IMAGE_NAME</span><span>: </span><span style="color:#cccccc;">backend
</span><span>  </span><span style="color:#ffffff;">before_script</span><span>:
</span><span>    - </span><span style="color:#cccccc;">echo $GOOGLE_APPLICATION_CREDENTIALS_BASE64 | base64 -d &gt; /kaniko/kaniko-secret.json
</span><span>  </span><span style="color:#ffffff;">script</span><span>:
</span><span>    - </span><span style="color:#eccdbb;">&gt;-
</span><span style="color:#cccccc;">      /kaniko/executor
</span><span style="color:#cccccc;">      --context &quot;$CI_PROJECT_DIR&quot;
</span><span style="color:#cccccc;">      --dockerfile &quot;$CI_PROJECT_DIR/backend.Dockerfile&quot;
</span><span style="color:#cccccc;">      --destination &quot;$IMAGE_REPO/$IMAGE_NAME:$CI_COMMIT_TAG&quot;
</span><span style="color:#cccccc;">      --build-arg STATICE_PYTOKEN=&quot;$STATICE_PYTOKEN&quot;
</span><span>  </span><span style="color:#ffffff;">only</span><span>:
</span><span>    - </span><span style="color:#cccccc;">tags
</span></code></pre>
<p>После добавления нового этапа в <code>.gitlab-ci.yml</code>, сборка будет запускаться при тегировании
определенного коммита.</p>
<p><img src="/images/kaniko-build-pipeline.png" alt="Пайплайн проекта" />
<span class="img-title">Пайплайн проекта</span></p>
<p>Как результат, в GCP Artifact Registry после успешного выполнения пайплайна появится образ
с именем вида <code>backend:{tag_name}</code>.</p>

    <nav>
      <div>
        <a href="https://akrisanov.com/ru/meetings/">&#8249; Встречи и звонки</a>
      </div>
      <div>
        <a href="https://akrisanov.com/ru/esim/"> eSIM как альтернатива роумингу в путешествиях &#8250;</a>
      </div>
    </nav>
</article>
  </main>
  <footer>
    <hr />
    <div class="c">
<nav class="tpad">
    <div></div>
</nav>
          
      <p class="s90"> © <span id="year">2025</span> Андрей Крисанов • Контент размещен на условиях <a rel="noopener" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.</p>
      <nav>
          <a class="s90"
            href="https://akrisanov.com/ru/atom.xml"
             target="_blank" rel="noopener noreferrer"
            aria-label=" RSS "
          ><i class="fa fa-rss" aria-hidden="true" title=" RSS "></i></a>
          <a class="s90"
            href="https://akrisanov.com/sitemap.xml"
             target="_blank" rel="noopener noreferrer"
            aria-label=" Карта сайта "
          ><i class="fa fa-sitemap" aria-hidden="true" title=" Карта сайта "></i></a>
          <a class="s90"
            href="https://akrisanov.com/ru/links"
             target="_blank" rel="noopener noreferrer"
            aria-label=" Contacts "
          ><i class="fa fa-address-card" aria-hidden="true" title=" Contacts "></i></a>
          <a class="s90"
            href="https://www.linkedin.com/in/akrisanov/"
             target="_blank" rel="noopener noreferrer"
            aria-label=" LinkedIn "
          ><i class="fa fa-linkedin" aria-hidden="true" title=" LinkedIn "></i></a>
          <a class="s90"
            href="https://github.com/akrisanov/"
             target="_blank" rel="noopener noreferrer"
            aria-label=" Github "
          ><i class="fa fa-github" aria-hidden="true" title=" Github "></i></a>
      </nav>
    </div>
  </footer><span class="topout">
  <span class="topleft"> </span
  ><a href="#" class="top" title="Back to Top"
    ><i class="svgs svgh angu"></i></a
  >
</span>
</body>
</html>

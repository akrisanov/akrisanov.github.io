
<!DOCTYPE html>
<html lang="en">
<head>
<script src="https://akrisanov.com/js/theme.min.js" integrity="sha384-pb++s6uBRKaQv+iAXpgA/H3IlpLZdO14tTwuCI7uXmz4aaZdByoCcM+6BhynMq/1"></script>
<link rel="stylesheet"
  href="https://akrisanov.com/abridge.css?h=7cb460406165e24193ad" />
<meta charset="utf-8" />
<meta http-equiv="x-ua-compatible" content="ie=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="base" content="https://akrisanov.com" />

<meta name="content-language" content="en" />
<meta name="HandheldFriendly" content="True" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="theme-color" content="#333333" />
<meta name="msapplication-TileColor" content="#333333" />
<link rel="manifest" href="https://akrisanov.com/manifest.min.json" />
<link rel="mask-icon" href="https://akrisanov.com/safari-pinned-tab.svg"
  color="#ff9900" />
<link rel="icon" type="image/svg+xml"
  href="https://akrisanov.com/favicon.png" />
<link rel="apple-touch-icon" sizes="180x180"
  href="https://akrisanov.com/apple-touch-icon.png" />
<link rel="preload" as="style" class="preStyle" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous" />
<link rel="alternate" type="application/atom+xml" title="Andrey Krisanov Atom Feed"
  href="https://akrisanov.com/atom.xml" />
<link rel="alternate" type="application/rss+xml" title="Andrey Krisanov RSS Feed"
  href="https://akrisanov.com/rss.xml" /> <meta name="robots" content="index, follow" />
<meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
<meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
<title>Building Multi-Arch Images for Arm and x86 | Andrey Krisanov</title>
<meta name="author" content="Andrey Krisanov" />
<meta name="copyright" content="Andrey Krisanov" />
<meta name="description" content="In situations where CI is not available, building multi-arch images locally can save the day." />
<link rel="canonical" href="https://akrisanov.com/multi-arch-docker-images/" />
<link rel="alternate" hreflang="en" href="https://akrisanov.com/multi-arch-docker-images/" />
<link rel="alternate" hreflang="x-default" href="https://akrisanov.com/multi-arch-docker-images/" />
<meta name="keywords" content="docker, devops, arm, x86, multi-arch, AI infrastructure, inference engineering, LLM serving, distributed systems, scalable backend, performance optimization, reliability, observability, MLOps, DevOps, GPU inference, model serving, vLLM, Triton Inference Server, Ray Serve, .NET, C#, Python, Kubernetes, Docker, Terraform, Ansible, OpenTelemetry, Grafana, CI&#x2F;CD, cloud infrastructure, platform engineering" />
<meta name="google-site-verification" content="Your Google Site verification code." />
<meta name="msvalidate.01" content="Your Bing Site verification code." />
<meta property="og:url" content="https://akrisanov.com/multi-arch-docker-images/" />
<meta name="twitter:url" content="https://akrisanov.com/multi-arch-docker-images/" />
<meta property="og:description" content="In situations where CI is not available, building multi-arch images locally can save the day." />
<meta name="twitter:description" content="In situations where CI is not available, building multi-arch images locally can save the day." />
<meta property="og:title" content="Building Multi-Arch Images for Arm and x86 | Andrey Krisanov" />
<meta name="twitter:title" content="Building Multi-Arch Images for Arm and x86 | Andrey Krisanov" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://akrisanov.com/images/docker-arm-build.png" />
<meta property="og:image" content="https://akrisanov.com/images/docker-arm-build.png" />
<meta property="og:site_name" content="Andrey Krisanov" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="website" />
<meta property="og:updated_time" content="2023-08-10" />
<meta name="twitter:site" content="@_akrisanov" />
<meta name="twitter:creator" content="@_akrisanov" /><script type="application/ld+json">
{
	"@context": "https://schema.org",
	"@type": "Article",
	"headline": "Building Multi-Arch Images for Arm and x86",
	"url": "https://akrisanov.com/multi-arch-docker-images/",
	"inLanguage": "en",
	"author": {
		"@type": "Person",
		"name": "Andrey Krisanov"
	},
	"image": "https://akrisanov.com/images/docker-arm-build.png",
	"datePublished": "2023-08-10T00:00:00+00:00",
	"dateModified": "2023-08-10T00:00:00+00:00"}
</script>
<script defer
  src="https://akrisanov.com/js/abridge.min.js?h=1a12cf684ae4ed40434f" integrity="sha384-ZsreuwU2rKTp7gC4bTf5sYz+3AjMym99XDa/B5wa08fCzLVVX+NDaTsTeyLXseDG"></script>
<noscript>
  <link rel="stylesheet" href="https://akrisanov.com/nojs.css" />
</noscript>
  
  <script>
    (function(){
      try {
        var pref = "";
        if (pref) {
          document.documentElement.classList.add('js');
          document.addEventListener('DOMContentLoaded', function(){
            document.body.classList.add(pref);
          });
        }
      } catch(e){}
    })();
  </script>
</head>
<body>
  <a class="visually-hidden" href="#main-content">Skip to content</a>
  <header>
    <nav>
      <div><h1><a href="https://akrisanov.com" title="Andrey Krisanov"><big>Andrey Krisanov</big></a></h1></div>
      <div>

        <div>
          <ul><li><a class="s95" href="https://akrisanov.com/about/"
                  > About 
                </a></li><li><a class="s95" href="https://akrisanov.com/archive/"
                  >
                <i class="fa fa-bookmark" aria-hidden="true" title="Posts"></i>
                
                </a></li>
            <li><div class="dropdown"><i class="svgs world" type="reset" role="button" tabindex="0" aria-label="English"></i>
                <div class="dropdown-content">
                <span>English</span><a href="https://akrisanov.com/ru/multi-arch-docker-images/">Русский</a></div>
            </div></li><li>
          <i type="reset" id="mode" class="js svgs adjust" role="button" tabindex="0"
            title="Switch Mode"
            aria-label="Switch Mode"></i></ul>
        </div>

        <div>
          <div>
            <form autocomplete=off class="js" name="goSearch" id="searchbox" role="search" aria-label="Search">
              <div class="searchd">
      <input id="searchinput" type="text" placeholder="Search"
        aria-label="Search" title="Search" />
                <button type="submit" title="Search" aria-label="Search" class="svgs search"></button>
              </div>
              <div class="results" aria-live="polite"><div id="suggestions"></div></div>
            </form>
          </div>
        </div>

      </div>
    </nav>
  </header>
  <main id="main-content">
<article>
<h1><a href="https://akrisanov.com/multi-arch-docker-images/">Building Multi-Arch Images for Arm and x86</a></h1>

<span class="s95" > August 10, 2023<span class="hpad">·</span> #<a
    href="https://akrisanov.com/tags/docker/">docker</a>  #<a
    href="https://akrisanov.com/tags/devops/">devops</a> </span>  <p>At work, I am involved in the development of a machine learning SDK and cloud services for
privacy and data protection. Like almost every company in this space, we rely heavily on
Python's scientific ecosystem. Because it's quite mature and depends on native library
development that started years ago, getting these packages to work on new architectures
can be tedious.</p>
<p>I am one of the few developers on our team who has stuck with MacOS and have a Macbook Pro
with M1 chip. There is no easy way for me to bootstrap our development environment in a matter
of minutes. I have to use Conda, install specific versions of Python packages, patch some native
libraries, and even create a symlink from an OS-specific package to its generic name
(I'm talking to you, Tensorflow). People on the <code>x86_64</code> architecture generally won't have
this problem – almost every package we use comes with a pre-built wheel for a chosen OS.
Moreover, to install the SDK as a dependency of, say, an HTTP API service, I had to assemble
it from sources: <code>pip install -e '.'</code></p>
<p>A few months ago we didn't even support the Arm64 architecture at a build level. This changed when
I introduced a Github Action pipeline to build Python wheels for Linux <code>x86_64</code>, <code>aarch64</code>, and <code>universal</code>.
Instead of manually compiling some native libraries on my machine, I moved the work to GitHub and
its Linux instances. From that moment on, I could just get the package from a private PyPI registry.
The sad truth is that I still use Conda and sometimes patch one or two transitive dependencies for
my M1 chip. But other than that, no hard times to date.</p>
<p>Today I needed to distribute a newly created API service with the SDK inside as a Docker image.
And I haven't found an easy way to define a Dockerfile that can be built and run on
Apple Silicon without Conda:</p>
<pre data-lang="Dockerfile" style="background-color:#3b224c;color:#dbbfef;" class="language-Dockerfile "><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#eccdbb;">FROM</span><span> python:3.9-slim-buster </span><span style="color:#eccdbb;">AS </span><span style="color:#a4a0e8;">base
</span><span>
</span><span style="color:#eccdbb;">ENV </span><span>PYTHONDONTWRITEBYTECODE=1
</span><span style="color:#eccdbb;">ENV </span><span>PYTHONUNBUFFERED=1
</span><span>
</span><span style="color:#6a7c81;"># Install Conda
</span><span>
</span><span style="color:#eccdbb;">RUN </span><span>apt-get update &amp;&amp; apt-get -y upgrade
</span><span style="color:#eccdbb;">RUN </span><span>apt-get install -y --no-install-recommends build-essential g++ gcc libssl-dev cmake git wget
</span><span style="color:#eccdbb;">RUN </span><span>rm -rf /var/lib/apt/lists/*
</span><span>
</span><span style="color:#eccdbb;">ENV </span><span>PATH=</span><span style="color:#cccccc;">&quot;/root/miniconda3/bin:${PATH}&quot;
</span><span style="color:#eccdbb;">ARG </span><span>PATH=</span><span style="color:#cccccc;">&quot;/root/miniconda3/bin:${PATH}&quot;
</span><span>
</span><span style="color:#eccdbb;">RUN </span><span>wget \
</span><span>    https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh \
</span><span>    &amp;&amp; mkdir /root/.conda \
</span><span>    &amp;&amp; bash Miniconda3-latest-Linux-aarch64.sh -b \
</span><span>    &amp;&amp; rm -f Miniconda3-latest-Linux-aarch64.sh
</span><span>
</span><span style="color:#6a7c81;"># Create a Conda environment and install native dependencies
</span><span>
</span><span style="color:#eccdbb;">RUN </span><span>--mount=type=cache,target=/root/.cache \
</span><span>    conda init bash &amp;&amp; . /root/.bashrc &amp;&amp; \
</span><span>    conda update conda &amp;&amp; \
</span><span>    conda create -n de_agent python=3.9 &amp;&amp; \
</span><span>    conda env config vars set -n de_agent LD_PRELOAD=/usr/lib/aarch64-linux-gnu/libgomp.so.1 &amp;&amp; \
</span><span>    conda activate de_agent &amp;&amp; \
</span><span>    conda install gdal llvmdev dm-tree -y &amp;&amp; \
</span><span>    pip install --upgrade pip setuptools wheel &amp;&amp; \
</span><span>    pip install h3
</span><span>
</span><span style="color:#6a7c81;"># Copy application files
</span><span>
</span><span style="color:#eccdbb;">WORKDIR </span><span>/app
</span><span>
</span><span style="color:#eccdbb;">COPY</span><span> app/ .
</span><span style="color:#eccdbb;">COPY</span><span> logging.yaml .
</span><span style="color:#eccdbb;">COPY</span><span> main.py .
</span><span style="color:#eccdbb;">COPY</span><span> requirements.txt ./
</span><span>
</span><span style="color:#6a7c81;"># Install Python packages
</span><span>
</span><span style="color:#eccdbb;">ARG </span><span>DE_AGENT_PYPI_TOKEN
</span><span>
</span><span style="color:#eccdbb;">RUN </span><span>--mount=type=cache,target=/root/.cache \
</span><span>    . /root/.bashrc &amp;&amp; conda activate de_agent &amp;&amp; \
</span><span>    pip install -r requirements.txt --extra-index-url=https://${DE_AGENT_PYPI_TOKEN}:@pypi.****.ai/pypi/ &amp;&amp; \
</span><span>    pip install numpy==1.23.5
</span><span>
</span><span style="color:#6a7c81;"># Cleanup
</span><span>
</span><span style="color:#eccdbb;">RUN </span><span>apt -qy purge --auto-remove build-essential g++ gcc libssl-dev cmake git wget
</span><span style="color:#eccdbb;">RUN </span><span>apt autoremove &amp;&amp; apt clean
</span><span style="color:#eccdbb;">RUN </span><span>rm -rf /var/lib/apt/lists/*
</span><span>
</span><span style="color:#6a7c81;"># Create a user
</span><span>
</span><span style="color:#eccdbb;">RUN </span><span>groupadd -r de_agent &amp;&amp; useradd -r -m -g de_agent de_agent
</span><span style="color:#eccdbb;">RUN </span><span>chown -R de_agent:de_agent /app
</span><span>
</span><span style="color:#eccdbb;">USER </span><span>de_agent
</span><span>
</span><span style="color:#6a7c81;"># Run the web application
</span><span>
</span><span style="color:#eccdbb;">EXPOSE </span><span>8000
</span><span>
</span><span style="color:#eccdbb;">ENTRYPOINT </span><span>[</span><span style="color:#cccccc;">&quot;PYTHONPATH=.&quot;</span><span>, </span><span style="color:#cccccc;">&quot;python&quot;</span><span>, </span><span style="color:#cccccc;">&quot;main.py&quot;</span><span>]
</span></code></pre>
<p>As you can see, the manifest is quite verbose. It also adds the Conda binaries and related
files to a release image. It is a price that must be paid.</p>
<p>Fortunately, for Linux, we don't need all of this machinery:</p>
<pre data-lang="Dockerfile" style="background-color:#3b224c;color:#dbbfef;" class="language-Dockerfile "><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#eccdbb;">FROM</span><span> python:3.9-slim-buster </span><span style="color:#eccdbb;">AS </span><span style="color:#a4a0e8;">base
</span><span>
</span><span style="color:#eccdbb;">ENV </span><span>PYTHONDONTWRITEBYTECODE=1
</span><span style="color:#eccdbb;">ENV </span><span>PYTHONUNBUFFERED=1
</span><span>
</span><span style="color:#6a7c81;"># Install system packages
</span><span>
</span><span style="color:#eccdbb;">RUN </span><span>apt-get update &amp;&amp; apt-get -y upgrade
</span><span style="color:#eccdbb;">RUN </span><span>apt-get install -y --no-install-recommends build-essential g++ gcc libssl-dev cmake git wget
</span><span style="color:#eccdbb;">RUN </span><span>rm -rf /var/lib/apt/lists/*
</span><span>
</span><span style="color:#6a7c81;"># Copy application files
</span><span>
</span><span style="color:#eccdbb;">WORKDIR </span><span>/app
</span><span>
</span><span style="color:#eccdbb;">COPY</span><span> app/ .
</span><span style="color:#eccdbb;">COPY</span><span> logging.yaml .
</span><span style="color:#eccdbb;">COPY</span><span> main.py .
</span><span style="color:#eccdbb;">COPY</span><span> requirements.txt ./
</span><span>
</span><span style="color:#6a7c81;"># Install Python dependencies
</span><span>
</span><span style="color:#eccdbb;">ARG </span><span>DE_AGENT_PYPI_TOKEN
</span><span>
</span><span style="color:#eccdbb;">RUN </span><span>--mount=type=cache,target=/root/.cache \
</span><span>    pip install -r requirements.txt --extra-index-url=https://${DE_AGENT_PYPI_TOKEN}:@pypi.****.ai/pypi/
</span><span>
</span><span style="color:#6a7c81;"># Cleanup
</span><span>
</span><span style="color:#eccdbb;">RUN </span><span>apt -qy purge --auto-remove build-essential g++ gcc libssl-dev cmake git wget
</span><span style="color:#eccdbb;">RUN </span><span>apt autoremove &amp;&amp; apt clean
</span><span style="color:#eccdbb;">RUN </span><span>rm -rf /var/lib/apt/lists/*
</span><span>
</span><span style="color:#6a7c81;"># Create a user
</span><span>
</span><span style="color:#eccdbb;">RUN </span><span>groupadd -r de_agent &amp;&amp; useradd -r -m -g de_agent de_agent
</span><span style="color:#eccdbb;">RUN </span><span>chown -R de_agent:de_agent /app
</span><span>
</span><span style="color:#eccdbb;">USER </span><span>de_agent
</span><span>
</span><span style="color:#6a7c81;"># Run the web application
</span><span>
</span><span style="color:#eccdbb;">EXPOSE </span><span>8000
</span><span>
</span><span style="color:#eccdbb;">ENTRYPOINT </span><span>[</span><span style="color:#cccccc;">&quot;PYTHONPATH=.&quot;</span><span>, </span><span style="color:#cccccc;">&quot;python&quot;</span><span>, </span><span style="color:#cccccc;">&quot;main.py&quot;</span><span>]
</span></code></pre>
<p>The question now is how to build Docker images for both architectures on a Mac.
This is where Docker comes in. Docker Desktop officially supports <a rel="noopener" target="_blank" href="https://www.docker.com/blog/multi-arch-images/">building multi-arch images
for Arm and x86</a>. Learning this, I was able to
add a few targets to my Makefile to quickly build images:</p>
<pre data-lang="Makefile" style="background-color:#3b224c;color:#dbbfef;" class="language-Makefile "><code class="language-Makefile" data-lang="Makefile"><span style="color:#ffffff;">build</span><span style="color:#eccdbb;">: </span><span style="color:#6a7c81;"># Build a Docker image for x86_64
</span><span> </span><span style="color:#a4a0e8;">docker</span><span> buildx build</span><span style="font-style:italic;color:#a4a0e8;"> --platform</span><span> linux/amd64</span><span style="font-style:italic;color:#a4a0e8;"> -t</span><span> de-agent:amd64-latest</span><span style="font-style:italic;color:#a4a0e8;"> --build-arg</span><span> DE_AGENT_PYPI_TOKEN=</span><span style="font-style:italic;color:#eccdbb;">${</span><span style="font-style:italic;color:#a4a0e8;">DE_AGENT_PYPI_TOKEN</span><span style="font-style:italic;color:#eccdbb;">}</span><span style="font-style:italic;color:#a4a0e8;"> -f</span><span> Dockerfile.amd64</span><span style="font-style:italic;color:#a4a0e8;"> --no-cache</span><span> .
</span><span>
</span><span style="color:#ffffff;">build-arm</span><span style="color:#eccdbb;">: </span><span style="color:#6a7c81;"># Build a Docker image for arm64
</span><span> </span><span style="color:#a4a0e8;">docker</span><span>  buildx build</span><span style="font-style:italic;color:#a4a0e8;"> --platform</span><span> linux/arm64</span><span style="font-style:italic;color:#a4a0e8;"> -t</span><span> de-agent:arm64-latest</span><span style="font-style:italic;color:#a4a0e8;"> --build-arg</span><span> DE_AGENT_PYPI_TOKEN=</span><span style="font-style:italic;color:#eccdbb;">${</span><span style="font-style:italic;color:#a4a0e8;">DE_AGENT_PYPI_TOKEN</span><span style="font-style:italic;color:#eccdbb;">}</span><span style="font-style:italic;color:#a4a0e8;"> -f</span><span> Dockerfile.arm64</span><span style="font-style:italic;color:#a4a0e8;"> --no-cache</span><span> .
</span></code></pre>
<pre data-lang="bash" style="background-color:#3b224c;color:#dbbfef;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#a4a0e8;">make</span><span> build
</span></code></pre>
<p><img src="/images/docker-arm-build.png" alt="Docker Image For Arm" />
<span class="img-title">Docker image built for the amd64 architecture</span></p>
<p>One can say, it's so much hassle for doing all of this locally and a proper CI can solve such
a case easily. I agree – as I've mentioned, I like shifting work out of my shoulders and giving it
to some machine in the cloud. But in situations where CI is not available, creating multi-arch
images can save the day. It certainly did for me.</p>

    <nav>
      <div>
        <a href="https://akrisanov.com/it-is-not-dns/">&#8249; My "It's not DNS" story</a>
      </div>
      <div>
        <a href="https://akrisanov.com/crypto-wallet-vulnerability/"> Accidentally found a vulnerability in a crypto wallet and made $1,000 &#8250;</a>
      </div>
    </nav>
</article>
  </main>
  <footer>
    <hr />
    <div class="c">
<nav class="tpad">
    <div></div>
</nav>
          
      <p class="s90"> © <span id="year">2025</span> Andrey Krisanov</p>
      <nav>
          <a class="s90"
            href="https://akrisanov.com/atom.xml"
             target="_blank" rel="noopener noreferrer"
            aria-label=" RSS "
          ><i class="fa fa-rss" aria-hidden="true" title=" RSS "></i></a>
          <a class="s90"
            href="https://akrisanov.com/sitemap.xml"
             target="_blank" rel="noopener noreferrer"
            aria-label=" Sitemap "
          ><i class="fa fa-sitemap" aria-hidden="true" title=" Sitemap "></i></a>
          <a class="s90"
            href="https://akrisanov.com/links"
             target="_blank" rel="noopener noreferrer"
            aria-label=" Contacts "
          ><i class="fa fa-address-card" aria-hidden="true" title=" Contacts "></i></a>
          <a class="s90"
            href="https://www.linkedin.com/in/akrisanov/"
             target="_blank" rel="noopener noreferrer"
            aria-label=" LinkedIn "
          ><i class="fa fa-linkedin" aria-hidden="true" title=" LinkedIn "></i></a>
          <a class="s90"
            href="https://github.com/akrisanov/"
             target="_blank" rel="noopener noreferrer"
            aria-label=" Github "
          ><i class="fa fa-github" aria-hidden="true" title=" Github "></i></a>
      </nav>
    </div>
  </footer><span class="topout">
  <span class="topleft"> </span
  ><a href="#" class="top" title="Back to Top"
    ><i class="svgs svgh angu"></i></a
  >
</span>
</body>
</html>
